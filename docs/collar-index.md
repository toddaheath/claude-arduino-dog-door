# Smart Collar Companion — Document Index

## Design Documents

| Document | Description |
|----------|-------------|
| [collar-device-design.md](collar-device-design.md) | **Master design** — hardware selection (ESP32-S3), BOM ($45), pin assignments, power budget (5-14 day battery life), physical form factor, firmware state machine, NFC handshake overview, BLE service definition, geofence engine overview, API model design, SPA page overview, data flow diagrams, implementation phases, open questions |
| [collar-nfc-protocol.md](collar-nfc-protocol.md) | **NFC protocol specification** — ISO 14443-4 tag emulation, TLV message format, full handshake sequence with timing, all message payload specifications (byte-level), security model (HMAC-SHA256 challenge-response, replay protection, brute force prevention, constant-time comparison), door firmware integration code, collar firmware tag emulation code, test strategy |
| [collar-geofence-engine.md](collar-geofence-engine.md) | **Geofence engine** — coordinate system (WGS84 + equirectangular projection), polygon/circle/corridor containment algorithms with C code, evaluation order (deny overrides allow), hysteresis buffer (3m to prevent GPS flapping), GPS quality gating, breach response escalation timeline, buzzer patterns, proximity warnings, fence sync protocol (API → collar via WiFi/BLE), NVS storage layout, performance budget (<100us per evaluation), distance-to-boundary calculations, full unit test case list |
| [collar-api-specification.md](collar-api-specification.md) | **API specification** — all new REST endpoints (collar CRUD, NFC verify, location batch upload/query/current, movement stats with heatmap, geofence CRUD/events/sync, map tile proxy), request/response schemas with JSON examples, fused confidence calculation, location data retention policy, notification integration (6 new event types), complete database schema (SQL DDL for 6 new tables + ALTER for existing), background services (LocationRetentionService, CollarHealthMonitorService), rate limiting policies |
| [collar-spa-wireframes.md](collar-spa-wireframes.md) | **SPA wireframes** — ASCII mockups for all new pages (collar list, pairing modal, collar detail, live map, geofence editor, movement history playback, geofence events), component architecture tree, TypeScript type definitions, API client functions, Leaflet map integration (satellite tiles, drawing tools, heat map, real-time updates), updated navigation, dashboard integration, notification preferences, NPM dependencies |
| [collar-firmware-detail.md](collar-firmware-detail.md) | **Collar firmware implementation** — PlatformIO config, all config constants, complete main.cpp state machine (boot → wake/classify → GPS tracking → NFC ready → WiFi upload → OTA update → low power), GPS tracker module (u-blox UBX protocol, SBAS, power save, adaptive rate), IMU manager (LSM6DSO step detection, motion classification, daily stats), power manager (LiPo discharge curve, EMA smoothing, charging detection), WiFi uploader (batch location upload, geofence sync, OTA), storage manager (NVS + SPIFFS layout), BLE collar service (NimBLE, all 6 characteristics, command handler), watchdog, memory budget (Flash 8MB + RAM 512KB + PSRAM 8MB) |
| [collar-door-integration.md](collar-door-integration.md) | **Door-side changes** — PN532 reader wiring options for ESP32-CAM (GPIO constraint analysis, 4 options evaluated), updated BOM (+$6), new firmware modules (nfc_reader, collar_scanner), config.h additions, NFC reader initialization and scanning code, collar BLE scanner code, updated access pipeline (parallel camera + collar detection), API client update for collar fields, backward compatibility guarantees, timing budget analysis (+100-200ms), test strategy with specific xUnit test cases |
| [collar-helm-deployment.md](collar-helm-deployment.md) | **Deployment changes** — EF Core migration details, TimescaleDB consideration (optional hypertable + compression), Helm chart changes (configmap, PVC for tile cache, deployment volume mounts, values.yaml), Docker Compose additions, CI/CD additions (collar test category, firmware CI workflow), resource estimates (storage, memory, tile cache sizing) |
| [collar-mobile-companion.md](collar-mobile-companion.md) | **Mobile app concept (future)** — React Native recommendation, core features (BLE provisioning, real-time map, push notifications, find-my-dog, activity dashboard), BLE provisioning flow, push notification architecture and payloads, app screen mockups, API changes for device registration, implementation priority |
| [collar-ota-updates.md](collar-ota-updates.md) | **OTA firmware updates** — update architecture (API → WiFi → flash), API endpoints for firmware management (upload, check, download, confirm), collar-side implementation (download streaming with SHA256 verification, OTA partition writes, rollback protection via ESP32 bootloader), self-test suite (IMU, GPS, BLE, NFC, power), staged rollout strategy, database models (CollarFirmware, CollarFirmwareDeployment), security considerations (binary signing, HTTPS, SHA256, battery gate) |
| [collar-security-analysis.md](collar-security-analysis.md) | **Security analysis** — threat model (assets, actors, attack surfaces), detailed attack analysis with mitigations (NFC replay, collar cloning, BLE eavesdropping, WiFi credential theft, GPS spoofing, API MITM, firmware tampering, door bypass), privacy considerations (location data, geofence boundaries, data minimization), Secure Boot & flash encryption setup (eFuse provisioning), key management table, FCC/CE compliance notes, battery safety, animal safety (weight, buzzer volume) |
| [collar-testing-strategy.md](collar-testing-strategy.md) | **Testing strategy** — collar firmware unit tests (geofence engine: 20+ test cases, NFC protocol: HMAC vectors + TLV encoding, power manager), API integration tests (collar CRUD, NFC verify, location upload, geofence, fused access: 25+ test cases), SPA component tests (CollarCard, GeofenceEditor), end-to-end hardware-in-the-loop tests (9 scenarios), integration scenario tests (6 scenarios), performance/load tests (4 API + 4 firmware), CI pipeline gates, hardware test bench diagram |
| [collar-pcb-enclosure.md](collar-pcb-enclosure.md) | **PCB & enclosure design** — full schematic with power tree (TP4056 → TPS63001 → 3.3V rail), I2C bus config, UART config, GPS power gate circuit (Si2302 MOSFET), battery voltage divider, buzzer driver (2N2222), PCB layout (2-layer, 45x30mm, component placement, NFC antenna coil on Layer 2), critical layout rules (GPS keepout, NFC tuning), enclosure design (TPU 95A, IP67 sealing strategy, collar attachment options), assembly process (16 steps), programming/provisioning station script, design file list, cost analysis ($70 single unit, $37.50 at 100+) |
| [collar-ota-updates.md](collar-ota-updates.md) | **OTA firmware updates** — update architecture, API endpoints, collar-side download + SHA256 verification + rollback, staged rollout |
| [collar-market-comparison.md](collar-market-comparison.md) | **Market comparison** — competitive analysis vs Fi, Whistle, Tractive, SpotOn, AirTag, SureFlap, Petvation; feature matrix (16 features across 6 competitors); unique value propositions (no subscription, NFC+camera fusion, satellite geofence editor, open source); target user profiles; honest limitations and trade-offs; future roadmap advantages |
| [collar-implementation-roadmap.md](collar-implementation-roadmap.md) | **Implementation roadmap** — 6 phases with detailed task checklists (hardware, firmware, API, SPA, Helm per phase), dependency chains, effort estimates (375 total hours: 135h firmware, 90h API, 120h SPA, 30h hardware), milestone checkpoints with concrete verification criteria |
| [collar-home-assistant-integration.md](collar-home-assistant-integration.md) | **Home Assistant + MQTT** — MQTT topic hierarchy, message payloads for all events (location, battery, activity, geofence, door access, commands), HA MQTT auto-discovery configs (device_tracker, sensors, binary_sensors, buttons), example automations (flash lights on breach, TTS door announcements, low battery reminder, auto-lock at night, welcome home), MQTTnet API publisher implementation (C#), Lovelace dashboard card config |
| [collar-multi-dog-scenarios.md](collar-multi-dog-scenarios.md) | **Multi-dog scenarios** — simultaneous door approach, allowed + blocked dog together, missing collar fallback, wrong collar on wrong dog (disagreement detection), new dog onboarding; geofence multi-dog (per-dog rules, follow-into-restricted, simultaneous breach, notification dedup); environmental edge cases (rain/snow GPS, magnetic interference, physical escape, sleeping by door, power outage); collar lifecycle (transfer, multiple collars, crash loop rollback); API scalability analysis (1-10,000 collars) |
| [collar-power-optimization.md](collar-power-optimization.md) | **Power optimization** — per-component power profiles (ESP32-S3, MAX-M10S, PN532, LSM6DSO, peripherals), power state analysis (deep sleep 100uA, tracking 5.7mA, WiFi burst 310mA), daily budget scenarios (3.1-38 days depending on usage), 6 optimization techniques (GPS PSM, adaptive rate, WiFi fast reconnect + caching, BLE interval tuning, NFC power gating, dynamic CPU freq), battery life summary (8-12 days typical), charging behavior, battery health management, thermal protection |
| [collar-dog-training-guide.md](collar-dog-training-guide.md) | **Dog training guide** — positive reinforcement philosophy, 5-phase training protocol (introduction → leashed walk → long line → supervised off-leash → unsupervised), buzzer sound configuration per fence type, breed-specific considerations, troubleshooting (ignores buzzer, afraid of buzzer, blast-through, boundary dancing), safety notes, configurable training parameters |
| [collar-gps-accuracy-analysis.md](collar-gps-accuracy-analysis.md) | **GPS accuracy analysis** — error budget breakdown (ionospheric, multipath, HDOP, noise), real-world accuracy by conditions (1.5-20m), SBAS correction, false/missed breach rate analysis with math, minimum fence size recommendations, position filtering algorithms (moving average, speed-adaptive, IMU dead reckoning), geofence design guidelines for users (margins, narrow peninsulas, circles vs polygons), SPA validation warnings, future improvements (RTK, BLE beacons, UWB, dual-freq GPS), accuracy testing protocol |

## Quick Reference

### Hardware
- **Collar MCU**: ESP32-S3-MINI-1 ($4)
- **GPS**: u-blox MAX-M10S ($12)
- **NFC**: PN532 on collar (tag emulation) + PN532 on door (reader) ($6 each)
- **IMU**: LSM6DSO ($3)
- **Battery**: 500mAh LiPo, 5-14 day life
- **Total collar cost**: ~$45
- **Additional door cost**: ~$6

### Key UUIDs
- Collar BLE Service: `5a6d0001-8e7f-4b3c-9d2a-1c6e3f8b7d4e`
- Door BLE Service: `4fafc201-1fb5-459e-8fcc-c5c9c331914b` (existing)

### Key Algorithms
- NFC Auth: HMAC-SHA256 challenge-response (32-byte nonce, 256-bit shared secret)
- Geofence: Ray-casting (polygon), haversine (circle), perpendicular distance (corridor)
- Fusion: Camera + collar agreement boosts confidence by 0.15; disagreement halves it

### Implementation Phases
1. Collar hardware + basic firmware (GPS, BLE, power)
2. NFC door integration (PN532 reader, challenge-response)
3. API + location tracking (models, endpoints, map)
4. Virtual geofencing (editor, on-device engine, sync)
5. Polish + analytics (heat map, stats, OTA, notifications)
6. Mobile companion app (push, BLE provisioning)
